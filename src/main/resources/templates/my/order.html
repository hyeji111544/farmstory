<html xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{/layout/myLayout.html}">

<!--ë‚´ìš© ì‹œì‘-->
    <div id="my" layout:fragment="content">
        <script th:inline="javascript">
            // ì£¼ë¬¸ ë²ˆí˜¸ë³„ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ ì•„ì½”ë””ì–¸
            function accordionBtn() {
                const button = event.target; // í´ë¦­í•œ ë²„íŠ¼
                const btnParent = button.parentNode; // ë²„íŠ¼ì˜ ë¶€ëª¨
                const myOrderTitle = btnParent.parentNode; // ë¶€ëª¨ì˜ ë¶€ëª¨
                const orderByCompany = myOrderTitle.parentNode; // ë¶€ëª¨ì˜ ë¶€ëª¨ì˜ ë¶€ëª¨
                const myOrderRowAll = orderByCompany.querySelectorAll('.myOrderRow') // myOrderRowë“¤

                // myOrderRowë“¤ì„ í•˜ë‚˜ì”© ìˆœíšŒ
                Array.from(myOrderRowAll).forEach(function (myOrderRow) {
                    // í˜„ì¬ myOrderRowì˜ display ìƒíƒœë¥¼ ì²´í¬í•´ì„œ ì ‘ê¸° or í¼ì¹˜ê¸°
                    if (myOrderRow.style.display === "none") {
                        myOrderRow.style.display = "flex"; // í¼ì¹˜ê¸°
                        button.src = "/lotteon/images/icon-arrow-top.png";
                    }else {
                        myOrderRow.style.display = "none"; // ì ‘ê¸°
                        button.src = "/lotteon/images/icon-arrow-bottom.png";
                    }
                })
            }

            // ìƒí’ˆí‰ ì“°ê¸° ë°•ìŠ¤ë¡œ ì´ë¦„ê³¼ ë²ˆí˜¸ ì „ë‹¬í•˜ê¸°
            function moveProdData() {
                const button = event.target; // í´ë¦­í•œ ë²„íŠ¼
                const confirm = button.parentNode; // ë²„íŠ¼ì˜ ë¶€ëª¨
                const myOrderRow = confirm.parentNode // ë²„íŠ¼ì˜ ë¶€ëª¨ì˜ ë¶€ëª¨
                const myOrderInfo = myOrderRow.querySelector('.myOrderInfo'); // í• ì•„ë²„ì§€ì˜ ë‘˜ì§¸
                const prodName = myOrderInfo.querySelector('.InfoProdName'); // ìƒí’ˆ ì´ë¦„
                const detailNo = button.getAttribute('data-detailNo'); // ìƒí’ˆ ë²ˆí˜¸
                const prodNo = button.id; // ìƒí’ˆ ë²ˆí˜¸
                const popReview = document.getElementById('popReview'); // ìƒí’ˆí‰ì“°ê¸° ì°½
                const productName = popReview.querySelector('.productName');
                const productNo = popReview.querySelector('.productNo');
                const prodDetailNo = popReview.querySelector('.detailNo');

                productName.innerText = prodName.innerText;
                productNo.value = prodNo;
                prodDetailNo.value = detailNo;
            }

            // ë¦¬ë·° ì œì¶œ ë²„íŠ¼
            function btnReviewSubmit() {
                const reviewForm = document.getElementsByClassName('reviewForm')[0]; // ìƒí’ˆí‰ì“°ê¸° ì°½
                const popReview = document.getElementById('popReview'); // ìƒí’ˆí‰ì“°ê¸° ì°½
                const revScore = popReview.querySelector('.revScore').value;
                const revContent = popReview.querySelector('#revContent').value;
                const revThumb = popReview.querySelector('#revThumb').value;
                console.log(revScore)
                console.log(revContent)
                console.log(revThumb)
                if (revScore != "" && revContent != "" && revThumb != "") {
                    reviewForm.submit();
                }else{
                    alert("í•­ëª©ì„ ë¹ ì§ì—†ì´ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                }
            }

            window.onload = function () {
                highlight();
                /* ë³„ */
                const stars = document.querySelectorAll('.star');

                stars.forEach(star => {
                    star.addEventListener('mouseover', function () {
                        const value = this.getAttribute('data-value');
                        highlightStars(value);
                    });

                    star.addEventListener('mouseleave', function () {
                        const ratedValue = document.querySelector('.ratingValue').getAttribute('data-rated');
                        highlightStars(ratedValue);
                    });

                    star.addEventListener('click', function () {
                        const value = this.getAttribute('data-value');
                        document.querySelector('.ratingValue').setAttribute('data-rated', value);
                        document.querySelector('.revScore').value = value;
                        highlightStars(value);
                    });
                });

                function highlightStars(value) {
                    stars.forEach(star => {
                        if (star.getAttribute('data-value') <= value) {
                            star.classList.add('clicked');
                        } else {
                            star.classList.remove('clicked');
                        }
                    });
                }
                // Review - ë³„ì 
                let rating = document.getElementsByClassName("rating");
                Array.from(rating).forEach(function (element) {
                    const revScore = parseInt(element.innerText);
                    switch (revScore){
                        case 1:
                            element.classList.add('star1');
                            break;
                        case 2:
                            element.classList.add('star2');
                            break;
                        case 3:
                            element.classList.add('star3');
                            break;
                        case 4:
                            element.classList.add('star4');
                            break;
                        case 5:
                            element.classList.add('star5');
                            break;
                    }
                });
            }

            //changePoint ì‚¬ìš©ì¼ë•Œ - ì¶œë ¥
            const changePoint = document.getElementById("changePoint");

            // ì œí’ˆ ìƒì„¸ ëª¨ë‹¬ ì •ë³´ ì¡°íšŒ
            function orderDetailModal() {
                const button = event.target;
                const orderNo = button.innerText;

                fetch(`/lotteon/my/home/orderDetailCheck/${orderNo}`)
                    .then(response => response.json())
                    .then(data => {
                        const orderDTOs = data.orderDetailDTOList;
                        const orderInfo = data.orderNoInfo[0];
                        const popOrder = document.getElementById('popOrder');
                        const orderUserName = document.getElementById('orderUserName')
                        const orderUserHp = document.getElementById('orderUserHp')
                        const orderUserDel = document.getElementById('orderUserDel')
                        const orderUserMemo = document.getElementById('orderUserMemo')

                        orderUserName.innerText = orderInfo.orderReceiver;
                        orderUserHp.innerText = orderInfo.orderHp;
                        orderUserDel.innerText = orderInfo.orderAddr;
                        if (orderInfo.orderMemo === "") {
                            orderUserMemo.innerText = "ë°°ì†¡ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤."
                        }else {
                            orderUserMemo.innerText = orderInfo.orderMemo;
                        }
                    })
                    .catch(err => console.log(err))
            }



            //ìˆ˜ì·¨ì¸í™•ì¸ ë²„íŠ¼ í´ë¦­
            function checkComplete(){
                const button = event.target; // í´ë¦­í•œ ë²„íŠ¼
                const popReceive = document.getElementById('popReceive'); // ìƒí’ˆí‰ì“°ê¸° ì°½
                const prodDetailNo = popReceive.querySelector('.detailNo');
                prodDetailNo.value = button.id;
            }

            // ìˆ˜ì·¨í™•ì¸
            function orderReceiveUpdate() {
                const popReceive = document.getElementById('popReceive');
                const detailNo = popReceive.querySelector('.detailNo').value;
                const userId = document.getElementsByClassName('userId')[0].value;

                fetch(`/lotteon/my/orderReceive/${detailNo}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        if (data.result > 0) {
                            window.location.href = "/lotteon/my/home?userId="+userId;
                        }else {
                            alert("ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        }
                    })
                    .catch(err => console.log(err))
            }

            // ìƒí’ˆ ë¬¸ì˜ ì‘ì„± ë²„íŠ¼
            function writeProdQna() {
                const button = event.target; // í´ë¦­í•œ ë²„íŠ¼
                const popQuestion = document.getElementById('popQuestion'); // ìƒí’ˆí‰ì“°ê¸° ì°½
                const userId = document.getElementsByClassName('userId')[0].value;
                const prodNoTag = popQuestion.querySelector('.prodNo');
                const userIdTag = popQuestion.querySelector('.userId');
                prodNoTag.value = button.id;
                userIdTag.value = userId;
            }

        </script>
        <!--ë§ˆì´í˜ì´ì§€ ìƒë‹¨ íšŒì› ì •ë³´-->
        <nav>
            <div>
                <a th:href="@{/my/home(userId=${#authentication.principal.user.userId})}"><img th:src="@{/images/my/my_logo.jpg}" alt="ë‚˜ì˜ì‡¼í•‘ì •ë³´"></a>

                <div class="UserInfo">
                    <p th:text="${#authentication.principal.user.userName}"></p>
                    <p th:text="${#authentication.principal.user.userGrade}"></p>
                    <input type="hidden" class="userId" th:value="${#authentication.principal.user.userId}">
                </div>
                <ol>
                    <li><a th:href="@{/my/order(userId=${#authentication.principal.user.userId})}">ì£¼ë¬¸Â·ë°°ì†¡<span class="delivery" th:text="${session.countOrder}"></span></a></li>
                    <li><a th:href="@{/my/coupon(userId=${#authentication.principal.user.userId})}">í• ì¸ì¿ í°<span class="coupon" th:text="${session.couponCount}"></span></a></li>
                    <li><a th:href="@{/my/point(userId=${#authentication.principal.user.userId})}">í¬ì¸íŠ¸<span class="point" th:text="${#numbers.formatInteger(session.pointBalance,3,'COMMA')}"></span></a></li>
                    <li><a th:href="@{/my/qna(userId=${#authentication.principal.user.userId}, cate='qna')}">ë¬¸ì˜ë‚´ì—­<span class="qna" th:text="${session.myQnaCount}"></span></a></li>
                </ol>
            </div>
        </nav>

        <div class="ordered">
            <!--ë§ˆì´í˜ì´ì§€ ì‚¬ì´ë“œë°”-->
            <ul class="myCate">
                <span class="menu_else"></span>
                <li class=""><a th:href="@{/my/order(userId=${#authentication.principal.user.userId})}">ì „ì²´ì£¼ë¬¸ë‚´ì—­</a></li>
                <li class=""><a th:href="@{/my/wish(userId=${#authentication.principal.user.userId})}">ê´€ì‹¬ìƒí’ˆ</a></li>
                <li class=""><a th:href="@{/my/point(userId=${#authentication.principal.user.userId})}">í¬ì¸íŠ¸ë‚´ì—­</a></li>
                <li class=""><a th:href="@{/my/coupon(userId=${#authentication.principal.user.userId})}">ì¿ í°</a></li>
                <li class=""><a th:href="@{/my/review(userId=${#authentication.principal.user.userId})}">ë‚˜ì˜ë¦¬ë·°</a></li>
                <li class=""><a th:href="@{/my/qna(userId=${#authentication.principal.user.userId}, cate='qna')}">ë¬¸ì˜í•˜ê¸°</a></li>
                <li class=""><a th:href="@{/my/info(userId=${#authentication.principal.user.userId})}">ë‚˜ì˜ì„¤ì •</a></li>
            </ul>

            <section>
                <th:block th:each="banner : ${banMyOrderList}" >
                <a th:href="@{http://__${banner.banLink}__}"><img th:src="@{/uploads/__${banner.banImgName}__}" alt="íŒ¨ì…˜, íƒ€ìš´ í•˜ë‚˜ë¡œ ë" class="banner"></a>
                </th:block>
                <article class="latest">
                    <h3>ì „ì²´ì£¼ë¬¸ë‚´ì—­</h3>
                    <!--ì£¼ë¬¸ë‚´ì—­ ê²€ìƒ‰ë°”-->
                    <div class="myOrderSearch">
                        <p>ê¸°ê°„ë³„ ì¡°íšŒ</p>
                        <a th:href="@{/my/order(userId=${#authentication.principal.user.userId})}" th:class="${MyOrderDTOList.cate == null} ? 'searchOn' : ''">ì „ì²´</a>
                        <a th:href="@{/my/order(userId=${#authentication.principal.user.userId}, cate='week')}" th:class="${MyOrderDTOList.cate == 'week'} ? 'searchOn' : ''">ì¼ì£¼ì¼</a>
                        <a th:href="@{/my/order(userId=${#authentication.principal.user.userId}, cate='halfmonth')}" th:class="${MyOrderDTOList.cate == 'halfmonth'} ? 'searchOn' : ''">15ì¼</a>
                        <a th:href="@{/my/order(userId=${#authentication.principal.user.userId}, cate='month')}" th:class="${MyOrderDTOList.cate == 'month'} ? 'searchOn' : ''">1ê°œì›”</a>
                        <a th:href="@{/my/order(userId=${#authentication.principal.user.userId}, cate='3month')}" th:class="${MyOrderDTOList.cate == '3month'} ? 'searchOn' : ''">3ê°œì›”</a>
                        <a th:href="@{/my/order(userId=${#authentication.principal.user.userId}, cate='6month')}" th:class="${MyOrderDTOList.cate == '6month'} ? 'searchOn' : ''">6ê°œì›”</a>
                        <a th:href="@{/my/order(userId=${#authentication.principal.user.userId}, cate='year')}" th:class="${MyOrderDTOList.cate == 'year'} ? 'searchOn' : ''">12ê°œì›”</a>
                        <form th:action="@{/my/order}" method="get" class="searchCustomDate">
                            <input type="date" name="startDate">
                            <p style="display: inline-block; width: 10px;">~</p>
                            <input type="date" name="finalDate">
                            <input type="hidden" name="cate" value="custom">
                            <input type="hidden" name="userId" th:value="${#authentication.principal.user.userId}">
                            <input type="submit" value="ê²€ìƒ‰">
                        </form>
                    </div>

                    <!--ì£¼ë¬¸ë‚´ì—­ ëª©ë¡-->
                    <!--ë‚´ì—­ì´ ì—†ì„ë•Œ-->
                    <div th:if="${MyOrderDTOList.myOrderDTOList.size()} == 0" class="myOrderList">
                        <div class="orderByCompany latest">
                            <div class="myOrderRow" style="border: 1px solid #aaa">
                                <p style="font-size : 18px">ğŸ›’ì£¼ë¬´ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.ğŸ›’</p>
                            </div>
                        </div>
                    </div>

                    <!--ë‚´ì—­ì´ ìˆì„ë•Œ-->
                    <div th:if="${MyOrderDTOList.myOrderDTOList.size()} > 0" class="myOrderList">
                        <div class="orderByCompany latest" th:each="linkedMap : ${MyOrderDTOList.myOrderDTOList}">
                            <div class="myOrderTitle">
                                <p th:text="${linkedMap.value.get(0).detailDate}"></p>
                                <p class="orderNo">ì£¼ë¬¸ë²ˆí˜¸<span th:text="${linkedMap.key}" onclick="orderDetailModal()" style="cursor: pointer"></span></p>
                                <p>
                                    <img th:src="@{/images/icon-arrow-top.png}" onclick="accordionBtn()"/>
                                </p>
                            </div>
                            <div class="myOrderRow" th:each="orderList : ${linkedMap.value}">
                                <div><img th:src="@{/uploads/__${orderList.thumb190}__}"></div>
                                <div class="myOrderInfo">
                                    <p class="company" th:text="${orderList.prodCompany}" style="cursor: pointer"></p>
                                    <p class="InfoProdName" th:text="${orderList.prodName}"></p>
                                    <p th:text="${orderList.count}"></p>
                                    <p th:text="${#numbers.formatInteger(orderList.detailPrice,3,'COMMA')}"></p>
                                </div>
                                <div th:text="${orderList.detailStatus}"></div>
                                <div class="confirm">
                                    <span class="receive" onclick="checkComplete()" th:id="${orderList.detailNo}">ìˆ˜ì·¨í™•ì¸</span>
                                    <span class="review" onclick="moveProdData()" th:id="${orderList.prodNo}" th:data-detailNo="${orderList.detailNo}">ìƒí’ˆí‰ì“°ê¸°</span>
                                    <span>ë°˜í’ˆì‹ ì²­</span>
                                    <span class="btnQuestion" onclick="writeProdQna()" th:id="${orderList.prodNo}">ë¬¸ì˜í•˜ê¸°</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p class="page" th:if="${MyOrderDTOList.myOrderDTOList.size()} > 0">
                        <a th:if="${MyOrderDTOList.prev && MyOrderDTOList.cate == null}" th:href="@{/my/order(pg=${MyOrderDTOList.start -1}, userId=${#authentication.principal.user.userId})}">ì´ì „</a>
                        <a th:if="${MyOrderDTOList.prev && MyOrderDTOList.cate != null}" th:href="@{/my/order(pg=${MyOrderDTOList.start -1}, type=${MyOrderDTOList.type}, keyword=${MyOrderDTOList.keyword}, userId=${#authentication.principal.user.userId})}">ì´ì „</a>

                        <th:block th:each="num:${#numbers.sequence(MyOrderDTOList.start, MyOrderDTOList.end)}">
                            <a class="pageNum" th:if="${MyOrderDTOList.cate == null}" th:href="@{/my/order(pg=${num}, userId=${#authentication.principal.user.userId})}" th:class="${num == MyOrderDTOList.pg} ? 'on' : ''">[[${num}]]</a>
                            <a class="pageNum" th:if="${MyOrderDTOList.cate != null}" th:href="@{/my/order(pg=${num}, type=${MyOrderDTOList.type}, cate=${MyOrderDTOList.cate}, keyword=${MyOrderDTOList.keyword}, userId=${#authentication.principal.user.userId})}" th:class="${num == MyOrderDTOList.pg} ? 'on' : ''">[[${num}]]</a>
                        </th:block>

                        <a th:if="${MyOrderDTOList.next && MyOrderDTOList.cate == null}" th:href="@{/my/order(pg=${MyOrderDTOList.end + 1}, userId=${#authentication.principal.user.userId})}">ë‹¤ìŒ</a>
                        <a th:if="${MyOrderDTOList.next && MyOrderDTOList.cate != null}" th:href="@{/my/order(pg=${MyOrderDTOList.end + 1}, type=${MyOrderDTOList.type}, keyword=${MyOrderDTOList.keyword}, userId=${#authentication.principal.user.userId})}">ë‹¤ìŒ</a>
                    </p>
                </article>
            </section>
        </div>
    </div>
<!--ë‚´ìš© ë-->

</html>

